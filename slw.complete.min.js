(function(){$.fn.slwComplete=$.fn.jqComplete=function(a){a=new SlwPlugins.SlwComplete(this,a);a.init();return a};SlwPlugins.SlwComplete=function(a,b){this.defaults={path:"../style/",data:[],dataFilter:null,dataFormat:null,width:"auto",maxHeight:null,autoHeight:!0,cssStyle:"",listStyle:"normal",createItemHandler:null,listClass:"ac",selectInput:!1,selectInputQuery:!0,selectMultiple:!1,maxItems:0,ajaxDataType:"json",ajaxParams:{},ajaxTimeout:3E3,ajaxType:"GET",afterDrawHandler:null,afterSelectedHandler:null,newTagHandler:null,onClose:null,onerror:function(a){alert(a)}};this.option=$.extend(this.defaults,b);this.loadDataFlag=!1;this.data=[];this.dataSrc=[];this.input=$(a);this.cancelBlur=this.showFlag=!1;this.selectIndex=this.beforeIndex=this.curIndex=-1;this.selectCtrl=this.selectShift=!1;this.allFlag=!0;this.windowHeight=500};SlwPlugins.SlwComplete.prototype={init:function(){this.windowHeight=$(window).height();this.initView();this.initEvent()},initView:function(){this.searchView=$('\x3cdiv class\x3d"'+this.option.listClass+'"\x3e\x3c/div\x3e');1==this.option.selectInput?(this.inputView=$('\x3cinput class\x3d"ac-input" type\x3d"text"/\x3e'),this.inputContainer=$('\x3cdiv class\x3d"ac-input-container"\x3e\x3c/div\x3e').append(this.inputView),this.searchView.append(this.inputContainer),0==this.option.selectInputQuery&&this.inputContainer.css({position:"absolute",display:"",width:"0px",height:"0px","z-index":-100,opacity:0})):this.inputView=this.input;this.ul=$("\x3cul\x3e\x3c/ul\x3e");this.searchView.append(this.ul);this.input.after(this.searchView);this.arrow("down");""!=this.option.cssStyle&&this.input.css(this.option.cssStyle)},initEvent:function(){var a=this;a.input.on("click",function(b){a.initShow()});a.inputView.attr("autocomplete","off");a.inputView.keydown(function(b){switch(b.keyCode){case 16:a.selectShift=!0;break;case 38:case 40:b.stopPropagation();b.preventDefault();a.move(b.keyCode);break;case 13:b.stopPropagation();b.preventDefault();a.select();break;case 17:a.selectCtrl=!0;break;case 65:a.selectAll();break;case 9:case 27:a.hide()}});a.inputView.keyup(function(b){switch(b.keyCode){case 16:a.selectShift=!1;break;case 17:a.selectCtrl=!1;break;case 13:case 38:case 40:break;case 9:case 27:a.hide();break;default:65==b.keyCode&&a.selectCtrl?a.allFlag=!a.allFlag:a.search()}});a.searchView.on("mouseenter","li",function(){a.searchView.find("li.selected").removeClass("selected");$(this).addClass("selected")}).on("mouseleave","li",function(){$(this).removeClass("selected")}).on("mousedown","li",function(b){b.stopPropagation();b.preventDefault();a.select($(this))});a.inputView.blur(function(b){a.cancelBlur?0==a.cancelBlur:a.blurHide()})},extraEvent:function(){var a=this;a.input.keydown(function(b){switch(b.keyCode){case 13:b.stopPropagation(),b.preventDefault(),a.initShow()}});a.input.keyup(function(a){switch(a.keyCode){case 13:a.stopPropagation(),a.preventDefault()}})},initShow:function(){var a=this;1==a.option.selectInput&&a.inputView.val("");a.showFlag=!a.showFlag;1==a.showFlag?(a.search(),a.cancelBlur=!0,$(window).on("resize.jqComplete",function(b){a.show()}),$(document).on("mousedown.jqComplete",function(b){b.stopPropagation();b.preventDefault();a.cancelBlur=!0;$.contains(a.searchView[0],b.target)||a.searchView.is(b.target)||(a.input.is(b.target)||$.contains(a.input[0],b.target)?a.cancelBlur=!0:(a.cancelBlur=!1,a.inputView.blur()))}),a.moveToActive(),a.inputView.focus()):a.hide()},hide:function(){this.blurHide();this.input.focus();$.isFunction(this.option.onClose)&&this.option.onClose.apply(this)},blurHide:function(){$(document).unbind("mousedown.jqComplete");$(window).unbind("resize.jqComplete");this.showFlag=!1;this.searchView.hide();this.arrow("down")},select:function(a){a instanceof jQuery||(a=this.searchView.find("li.selected"));if(0<a.length){var b=a.data("data");0==this.option.selectInput?(a.size()&&this.inputView.val(b.text),this.hide()):1==this.option.selectMultiple?this.selectMultiple(a):this.selectSingle(a);this.selectIndex=a.index();0==this.option.selectMultiple&&this.afterSelected(b);this.beforeIndex=b.index}$.isFunction(this.option.newTagHandler)&&this.option.newTagHandler.apply(this,[a.length,this.inputView])},afterSelected:function(a){$.isFunction(this.option.afterSelectedHandler)&&this.option.afterSelectedHandler.apply(this,[a,this.beforeIndex])},selectAll:function(){var a=this;a.option.selectMultiple&&a.selectCtrl&&a.searchView.find("li").each(function(){a.selectItem($(this),a.allFlag)})},selectSingle:function(a){a=a.data("data");if("undefined"==typeof this.data[a.index].selected||0==this.data[a.index].selected)0<=this.curIndex&&this.data.length>this.curIndex&&(this.data[this.curIndex].selected=!1),this.data[a.index].selected=!0,this.curIndex=a.index;this.hide()},selectMultiple:function(a){var b,c=a.index();if(this.selectShift&&-1!=this.selectIndex&&this.selectIndex!=c)for(c>this.selectIndex?b=this.selectIndex:(b=c,c=this.selectIndex),a=this.searchView.find("li").eq(this.selectIndex).hasClass("active");b<=c;b++){var d=this.searchView.find("li").eq(b);this.selectItem(d,a)}else this.selectItem(a,!a.hasClass("active"))},selectItem:function(a,b){var c=a.data("data");c.selected=b;this.data[c.index]=c;a.data("data",c);1==c.selected?a.addClass("active"):a.removeClass("active");this.afterSelected(c)},loadData:function(){var a=this;if(!a.loadDataFlag){if($.isArray(a.option.data))a.data=a.option.data.concat();else if($.isFunction(a.option.data))a.data=a.option.data();else if("string"===typeof a.option.data)if("dict"==a.option.ajaxDataType){var b=Slw.Dict.getDictList(a.option.data),c=0;$.each(b,function(b,e){a.data[c]={label:e.name,text:e.remark,value:e.code,index:c};c++})}else try{a.data=a.ajaxSend()}catch(d){a.error("ajax error: "+d);return}else{a.error("data error\uff01");return}a.formatJson();$.isFunction(a.option.dataFilter)&&(a.dataSrc=a.data.concat());a.loadDataFlag=!0}$.isFunction(a.option.dataFilter)&&(a.data=a.option.dataFilter.apply(a,[a.dataSrc]),a.reIndex())},reIndex:function(){$.each(this.data,function(a,b){b.index=a})},refreshSelect:function(){$.each(this.data,function(a,b){b.selected=!1})},dataFormat:function(a){a.text||(a.text=a.label)},inArray:function(a){var b=-1;this.loadData();$.each(this.data,function(c,d){if(d.value+""==a+"")return b=c,!1});return b},formatJson:function(){var a=this,b;$.each(a.data,function(c,d){$.isPlainObject(d)?(d.index=c,$.isFunction(a.option.dataFormat)?a.option.dataFormat.apply(a,[d]):a.dataFormat(d)):"string"===typeof d&&(b={label:d,text:d,value:d,index:c},a.data[c]=b)})},ajaxSend:function(){jQuery.support.cors=!0;var a=this,b=[];$.ajax(a.option.data,{async:!1,dataType:a.option.ajaxDataType,type:a.option.ajaxType,timeout:a.option.ajaxTimeout,data:a.option.ajaxParams,success:function(c,d,e){if("xml"===a.option.ajaxDataType)$(c).find("item").each(function(){for(var a={},c=0;c<this.attributes.length;c++)a[this.attributes[c].nodeName]=this.attributes[c].nodeValue;a.value||(a.value=$(this).text());a.text||(a.text=$(this).text());a.label||(a.label=$(this).text());b.push(a)});else if("json"===a.option.ajaxDataType)b=c;else throw"ajaxDataType error\uff01";},error:function(a,b,e){throw e;}});return b},getWidth:function(){if("number"===typeof this.option.width)return this.option.width;if("string"===typeof this.option.width&&"auto"===this.option.width.toLowerCase())return this.input.outerWidth()},move:function(a){var b=this.ul.find("li.selected");a=b.size()?38===a?b.prev():b.next():38===a?this.ul.find("li").last():this.ul.find("li").first();a.size()&&(this.ul.find("li").removeClass("selected"),a.addClass("selected"),this.moveTo(a))},moveToActive:function(){var a=this.ul.find("li.active").first();this.moveTo(a)},moveTo:function(a){if(0<a.length){var b=a.outerHeight();a=a.position().top-this.ul.position().top;b+a>this.ul.height()?this.ul.scrollTop(this.ul.scrollTop()+a+b-this.ul.height()):0>a&&this.ul.scrollTop(this.ul.scrollTop()+a)}},show:function(){if(null==this.option.maxHeight||1==this.option.autoHeight)this.searchView.css("height","auto"),this.ul.css("height","auto");if(0<this.option.maxHeight&&(this.searchView.css("max-height",this.option.maxHeight+"px"),Slw.Utils.isIE()&&10>Slw.Utils.ieVersion())){var a=this.searchView.height()>this.option.maxHeight?this.option.maxHeight+"px":"auto";this.searchView.css("height",a);this.ul.css("height",a)}a=this.getWidth();if(6==Slw.Utils.ieVersion()||7==Slw.Utils.ieVersion())a-=2,1==this.option.selectInput&&this.inputContainer.css("width",a-18+"px");var b=this.searchView.height()+3;this.ul.css("height",this.searchView.height()-(1==this.option.selectInput&&1==this.option.selectInputQuery?37:0)+"px");var c=this.input.position().left,d=this.input.position().top+this.input.outerHeight();d+b>this.windowHeight&&(d=this.input.position().top-b);this.searchView.css({left:c+"px",top:d+"px",width:a+"px",height:b+"px",display:"block"});this.arrow("up")},arrow:function(a){1==this.option.selectInput&&0==this.option.selectMultiple&&this.input.css("background-image","url("+this.option.path+a+"arrow.gif)")},search:function(){var a=this;a.loadData();a.selectIndex=-1;var b=this.inputView.val(),c=[];$.each(this.data,function(d,e){if(0<a.option.maxItems&&c.length>=a.option.maxItems)return!1;e.label=e.text;0==$.trim(b).length?c.push(e):a.match(b,e)&&c.push(e)});a.draw(c);a.show()},draw:function(a){var b=this,c=this.searchView.find("ul").empty();$.each(a,function(a,e){var d=$("\x3cli\x3e\x3c/li\x3e").appendTo(c).data("data",e),f=$("\x3cdiv\x3e\x3c/div\x3e").appendTo(d);switch(b.option.listStyle){case "iconList":var g=$("\x3cimg\x3e\x3c/img\x3e").attr("src",e.image);f.append($("\x3cspan\x3e\x3c/span\x3e").append(g)).append("\x3cspan\x3e"+e.label+"\x3c/span\x3e");break;case "custom":f.append(b.option.createItemHandler.apply(b,[a,e]));break;default:f.append("\x3cspan\x3e"+e.label+"\x3c/span\x3e")}$.isFunction(b.option.afterDrawHandler)&&b.option.afterDrawHandler.apply(b,[d,e])})},match:function(a,b){var c=RegExp(a.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"i").test(b.text);this.highlight(a,b);return c},highlight:function(a,b){b.label=b.text;var c=RegExp("("+a.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig");b.label=b.label.replace(c,"\x3cem\x3e$1\x3c/em\x3e")},error:function(a){$.isFunction(this.option.onerror)&&this.option.onerror.apply(this,[a])}}})(jQuery);